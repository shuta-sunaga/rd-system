# デバッグログ: Excel生成エラー調査

**日付**: 2025-12-23
**ステータス**: 調査中（一時中断）

---

## 問題概要

**症状**: Excel生成実行時にエラーが発生
- ユーザー画面: `Failed to fetch`
- コンソール: `Failed to load resource: net::ERR_HTTP2_PROTOCOL_ERROR`
- Vercel Log: ログなし

**発生条件**:
- ユーザーの個人PC: 正常動作
- とある会社のネットワーク内PC: エラー発生

---

## 調査結果

### 1. 初期分析

処理フロー:
1. PDF解析 (pdf-parse) → 0.5-2秒
2. Gemini Vision フォールバック（必要時） → 3-5秒
3. AI抽出 (Gemini API) → 3-8秒
4. Excel生成 (ExcelJS) → 1-3秒
5. **合計: 7.5-18秒** → Vercel無料プラン10秒制限を超過する可能性

### 2. 追加調査（会社ネットワーク）

| テスト | 結果 |
|--------|------|
| GET /api/health | ✅ OK (`{"status":"ok",...}` 返却) |
| POST /api/test-post | 最初405 → デプロイ後は空レスポンス（JSON解析エラー） |
| POST /api/generate | ❌ ERR_HTTP2_PROTOCOL_ERROR（8秒未満で発生） |

**重要な発見**:
- 8秒未満でエラー発生 → Vercel 10秒タイムアウトではない
- GETは成功、POSTで問題 → 会社プロキシがPOSTリクエストに干渉している可能性
- レスポンスが空で返ってくる → プロキシがレスポンスを切断/改変している可能性

---

## 実施した対策

### 1. フロントエンドエラーメッセージ詳細化 (コミット: c88de52)

**ファイル**: `public/index.html`

- AbortControllerでタイムアウト検知を追加（60秒）
- 経過時間に基づくエラー原因の推定表示
- ネットワークエラーとサーバーエラーを区別
- HTTPステータスコードの表示に対応

```javascript
// エラータイプに応じた詳細メッセージ
if (error.name === 'AbortError') {
  // フロントエンドタイムアウト
} else if (error instanceof TypeError && error.message === 'Failed to fetch') {
  if (elapsedSec >= 8) {
    // サーバータイムアウトの可能性
  } else {
    // ネットワーク接続エラー
  }
}
```

### 2. サーバー側Gemini APIエラー詳細化 (コミット: fff8f42)

**ファイル**:
- `src/services/aiExtractor.ts`
- `src/services/pdfParser.ts`

識別するエラータイプ:
- ネットワーク/ファイアウォールエラー
- タイムアウト
- SSL/TLS証明書エラー
- 認証エラー
- レート制限
- サーバーエラー

### 3. 診断用テストエンドポイント追加 (コミット: 15266e7)

**ファイル**: `src/server.ts`

```typescript
// POST /api/test-post - POSTリクエスト疎通テスト
// POST /api/test-upload - ファイルアップロード疎通テスト
```

---

## 現在の推定原因

**会社のプロキシ/ファイアウォールがPOSTリクエストのレスポンスを遮断している**

根拠:
1. GETリクエストは正常
2. POSTリクエストで空レスポンスが返る
3. 8秒未満で発生（サーバータイムアウトではない）
4. ERR_HTTP2_PROTOCOL_ERROR（HTTP/2プロトコルレベルの問題）

---

## 次のステップ（再開時）

### 確認すべきこと

1. **POSTテストの詳細確認**
   ```javascript
   fetch('/api/test-post', { method: 'POST' })
     .then(r => {
       console.log('Status:', r.status);
       return r.text();
     })
     .then(text => console.log('Body:', text))
     .catch(console.error)
   ```
   - ステータスコードは何か？
   - ボディは完全に空か、一部あるか？

2. **レスポンスヘッダーの確認**
   ```javascript
   fetch('/api/test-post', { method: 'POST' })
     .then(r => {
       console.log('Headers:', [...r.headers.entries()]);
       return r.text();
     })
   ```

3. **ファイルアップロードテスト**
   ```javascript
   const formData = new FormData();
   const testBlob = new Blob(['test'], { type: 'application/pdf' });
   formData.append('files', testBlob, 'test.pdf');

   fetch('/api/test-upload', { method: 'POST', body: formData })
     .then(r => r.text())
     .then(console.log)
     .catch(console.error)
   ```

### 検討すべき解決策

1. **Vercel Proプラン** - タイムアウト60秒に延長
2. **非同期処理化** - アップロード → ジョブID → ポーリング方式
3. **代替ホスティング** - AWS Lambda, Cloud Run等（会社プロキシとの相性次第）
4. **会社IT部門への相談** - プロキシ設定の確認/例外追加

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `src/server.ts` | APIエンドポイント定義 |
| `src/services/aiExtractor.ts` | Gemini API呼び出し・要件抽出 |
| `src/services/pdfParser.ts` | PDF解析・Gemini Vision フォールバック |
| `src/services/excelGenerator.ts` | Excel生成 |
| `public/index.html` | フロントエンド（エラーハンドリング含む） |
| `vercel.json` | Vercelデプロイ設定 |

---

## コミット履歴（本件関連）

```
15266e7 chore: 診断用テストエンドポイントを追加
fff8f42 feat: Gemini APIエラーの詳細メッセージを追加
c88de52 fix: エラーメッセージを詳細化してユーザビリティを向上
```

---

**最終更新**: 2025-12-23 17:30頃 (JST)
